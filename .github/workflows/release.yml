name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  gate:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      is_tag: ${{ steps.tag.outputs.is_tag }}
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.event.workflow_run.head_sha }}
      - id: tag
        shell: bash
        run: |
          tag="$(git tag --points-at "${{ github.event.workflow_run.head_sha }}" | head -n1)"
          if [ -n "$tag" ]; then
            echo "is_tag=true" >> "$GITHUB_OUTPUT"
            echo "tag=$tag" >> "$GITHUB_OUTPUT"
          else
            echo "is_tag=false" >> "$GITHUB_OUTPUT"
          fi

  release:
    needs: gate
    if: ${{ needs.gate.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ needs.gate.outputs.tag }}
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'
      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev \
            xorg-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libxxf86vm-dev \
            mingw-w64 \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            libc6-dev:arm64 \
            libgl1-mesa-dev:arm64 \
            libx11-dev:arm64 \
            libxrandr-dev:arm64 \
            libxinerama-dev:arm64 \
            libxi-dev:arm64 \
            libxcursor-dev:arm64 \
            libxxf86vm-dev:arm64
      - name: GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
